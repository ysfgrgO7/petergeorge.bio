rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if the user is an admin
    function isAdmin() {
      return request.auth != null &&
             request.auth.token.email_verified == true &&
             exists(/databases/$(database)/documents/admins/$(request.auth.token.email));
    }

    // Admins collection: Only the admin themselves can read their doc
    match /admins/{email} {
      allow read: if request.auth != null && request.auth.token.email == email;
      allow write: if false; // Only manageable via Firebase Console or Admin SDK
    }

    // Years, Courses, Lectures: Read for authenticated, Write for admins
    match /years/{year}/{document=**} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }

    // Students collection: Owner-only access
    match /students/{uid} {
      allow read: if request.auth != null && (request.auth.uid == uid || isAdmin());
      allow write: if request.auth != null && request.auth.uid == uid;

      // Progress subcollection
      match /progress/{progressId} {
        allow read: if request.auth != null && (request.auth.uid == uid || isAdmin());
        allow write: if request.auth != null && request.auth.uid == uid
                     && isValidProgress(request.resource.data);
      }

      // Homework Progress subcollection
      match /homeworkProgress/{homeworkId} {
        allow read: if request.auth != null && (request.auth.uid == uid || isAdmin());
        allow write: if request.auth != null && request.auth.uid == uid;
      }
    }

    function isValidProgress(data) {
      return (data.earnedMarks == null || data.earnedMarks is number) &&
             (data.total == null || data.total is number) &&
             (data.attempts is number) &&
             (data.quizCompleted is bool);
    }

    // Access codes: Read for authenticated, Update for students (marking as used), Create/Delete for admins
    match /accessCodes/{codeId} {
      allow read: if request.auth != null;
      allow update: if request.auth != null &&
                      request.resource.data.diff(resource.data).affectedKeys().hasOnly(['isUsed', 'usedBy', 'usedAt', 'lectureId', 'courseId', 'year']);
      allow create, delete: if isAdmin();
    }
  }
}
